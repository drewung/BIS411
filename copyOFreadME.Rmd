---
title: "NBA Draft Network Analysis Project"
author: "Marcus Li and Andrew Ung"
date: "6/6/2025"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: readable
    highlight: tango
---

## Narrative Summary

This project analyzes NBA player career trajectories and teammate networks using network analysis. We focus on the \_\_\_ draft class and \_\_\_ season teammates to explore how players connect through shared teams, and use network metrics and community detection to identify key players and roles. We also will be exploring "broker" players The goal is to visualize and interpret player dynamics through graph structures.

We use `nbastatR` to access real NBA data, and `igraph`, `ggraph`, and `dplyr` for data wrangling, network creation, and visualization. This work could help illustrate team structures and player centrality to coaches, analysts, or fans. \## Setup Process

```{r setup}
#installing packages
install.packages("remotes")
remotes::install_github("abresler/nbastatR", force = TRUE)

```

### Packages Used

```{r packages}
#packages needed
library(devtools)
library(dplyr)
library(future)
library(ggplot2)
library(igraph)
library(nbastatR)
library(Rtools)

library(sna)  # For brokerage analysis
```

### Reading the Data Sets

```{r datasets}
#Adjust VROOM buffer size for large data!
Sys.setenv(VROOM_CONNECTION_SIZE = 131072 * 10)

#change season to anything from (ex 2020:2024, from 2020 to 2024 seasons)
game_data <- game_logs(seasons = 2023)
```

### Creating Graph Objects

```{r graphObjects}
# Create player-to-player network based on shared teams
cat("Creating player teammate network...\n")


# Get all player-team-season combinations
player_teams <- game_data %>%
  select(namePlayer, slugTeam, slugSeason) %>%
  distinct()
  
teammate_pairs <- player_teams %>%
  group_by(slugTeam, slugSeason) %>%
  filter(n() > 1) %>%
  do({
    players <- .$namePlayer
    expand.grid(
      player1 = players,
      player2 = players,
      stringsAsFactors = FALSE
    ) %>%
    filter(player1 != player2)
  }) %>%
  group_by(player1, player2) %>%
  summarise(
    shared_teams = n(),
    teams = paste(unique(paste(slugTeam, slugSeason)), collapse = ", "),
    .groups = "drop"
  ) %>%
  filter(shared_teams >= 1)

cat("Teammate connections created:", nrow(teammate_pairs), "\n")

```

### Filtering

```{r filter}
#connection between players
player_connections <- teammate_pairs %>%
  group_by(player1) %>%
  summarise(total_teammates = n(), .groups = "drop") %>%
  arrange(desc(total_teammates))

#choose the top 50%
top_players <- head(player_connections$player1, 50)

filtered_network <- teammate_pairs %>%
  filter(player1 %in% top_players & player2 %in% top_players)


#Creates graph
players_network <- graph_from_data_frame(filtered_network, directed = FALSE)
# Simplify graph (remove loops and multiple edges)
players_network <- simplify(players_network)
```


###Detection

```{r detetcion}
# Community detection
communities <- cluster_louvain(players_network)
membership_vec <- membership(communities)

# Betweenness centrality
between <- igraph::betweenness(players_network)

#removed normalized true
bet_normalized <- igraph::betweenness(players_network)
bet.dat <- data.frame(
  player = V(players_network)$name,
  between = between,
  bet_normalized = bet_normalized,
  community = membership_vec
)


#showcases top broker players with between centrality
at("=== TOP BROKER PLAYERS (Betweenness Centrality) ===\n")
print(head(bet.dat[order(bet.dat$between, decreasing = TRUE),], 10))

#community structure
cat("\n=== COMMUNITY STRUCTURE ===\n")
cat("Number of communities:", max(membership_vec), "\n")
cat("Modularity:", round(modularity(communities), 3), "\n")

#members of each community
for(i in 1:min(5, max(membership_vec))) {
  community_players <- V(players_network)$name[membership_vec == i]
  cat("Community", i, ":", paste(head(community_players, 5), collapse = ", "), 
      ifelse(length(community_players) > 5, "...", ""), "\n")
}
```

### Brokerage Analysis
```{r brokerage}
#install intergraph to convert the network.
#install.packages("intergraph", dependencies = TRUE)

library(intergraph)
snaNetwork <- asNetwork(players_network)  # Convert igraph network into an sna object


library(statnet)
brokerage_results <- brokerage(snaNetwork, cl = get.vertex.attribute(snaNetwork, "community"))
brokerage_results$raw.nli
```

### Description of the Data and Link

## Network Plot

```{r plotting}
# Find the top player in each community
community_tops <- by(1:length(V(players_network)), membership(communities), function(idx) {
  community_betweenness <- between[idx]
  idx[which.max(community_betweenness)]
})

# Convert to vector of indices
top_in_each_community <- unlist(community_tops)

# Create label color and font vectors
label_colors <- rep("black", length(V(players_network)))
label_fonts <- rep(1, length(V(players_network)))

# Top player in each community - red and bold
label_colors[top_in_each_community] <- "blue"
label_fonts[top_in_each_community] <- 2

# Plot network
plot(players_network,
     layout = layout_with_kk(players_network),
     vertex.label = ifelse(between > quantile(between, 0.1), 
                           V(players_network)$name, NA),
     vertex.label.color = label_colors,
     vertex.label.font = label_fonts,
     vertex.label.cex = 0.8,
     vertex.color = membership(communities),
     vertex.size = between * 0.01 + 3,
     edge.width = 0.1,
     edge.color = "gray80",
     main = "NBA Player Communities\n(Red Labels = Community Leaders, Colors = Communities)")

```

## Final Summary
